[Unit]
Description=Install Scalock Gateway @ %i
After=docker.service bootstrap.service aqua-web@%i.service aqua-gateway@%i.service
Requires=docker.service


[Service]
User=core
TimeoutStartSec=0
Environment="SCALOCK_TOKEN=etcdctl get /aqua/config/aqua-token"
Environment="IMAGE=etcdctl get /images/scalock-agent"

ExecStartPre=/usr/bin/sh -c "source /etc/profile.d/etcdctl.sh"
ExecStartPre=/usr/bin/sh -c \
"if [[ -f /etc/profile.d/etcdctl.sh ]]; then source /etc/profile.d/etcdctl.sh;fi && docker pull $($IMAGE)"
ExecStartPre=-/usr/bin/docker kill aqua-agent
ExecStartPre=-/usr/bin/docker rm aqua-agent


ExecStart=/usr/bin/bash -c \
"if [[ -f /etc/profile.d/etcdctl.sh ]]; then source /etc/profile.d/etcdctl.sh;fi && \
  sudo docker run -ti --name aqua-agent \
  -e SCALOCK_SERVER=${COREOS_PRIVATE_IPV4} \
  -e SCALOCK_TOKEN=$($SCALOCK_TOKEN) \
  -e SILENT=yes \
  -v /var/run/docker.sock:/var/run/docker.sock \
  $($IMAGE)"


ExecStop=-/usr/bin/docker stop aqua-agent

[Install]
WantedBy=multi-user.target

[[X-Fleet]
Global=false
MachineMetadata=role=worker
MachineMetadata=ip=%i
